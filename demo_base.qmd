---
title: "Quarto Demo for DSAC/Eng CoP"
subtitle: "Medicare Growth in Pennsylvania"
author: "This guy"
date: "2026-01-23"
format: html
---


```{r}
#| label: dependencies
#| output: false
#| warnings: false
#| echo: false
library(tidyverse)
library(sf)
library(tigris)
library(scales)
library(gt)

options(tigris_use_cache = TRUE)

```

::: {.callout-tip}
## Base version

Let's start at square 1. Nothing fancy here. Basic yaml, use of markdown, code chunks, and inline code.

:::

::: {.callout-warning}

This demo report relies on R, but you can use R, Python, Julia, and Observable.

This demo report renders a document, but Quarto has a number of output options including documents, presentations, dahboards, websites, books.

:::

# BACKGROUND
This is an **important** annual report where we look at growth in beneficiaries at the county level in Pennsylvania. 

```{r}
#| label: read_data 
#| cache: true

#relative path
data_path <- "Medicare Monthly Enrollment/2025-10/Medicare Monthly Enrollment Data_October 2025.csv"

#read in data
df <- read_csv(
    data_path, 
    col_types = c(year = "i", tot_benes = "d", .default = "c"),
    name_repair = tolower
    )

```

```{r}
#| label: focus_state

#which state are we analyzing
focus_state <- "Pennsylvania"

```

Let's take a look at what data exists in this dataset. We can get more information at [Data.CMS.gov](https://data.cms.gov/resources/medicare-monthly-enrollment-data-dictionary). The dataset contains `r scales::label_comma()(nrow(df))` rows and `r ncol(df)` columns. The dataset covers the years from `r min(df$year)` to `r max(df$year)`. For this analysis, we will only be looking at the total beneficiary counts (`tot_benes`) in `r focus_state` counties from 2020 to 2024.

## Initial Munge

From here we will be doing X, Y, and Z to subset the dataset needed to calculate growth rate.

```{r}
#| label: initial_munge

#subset dataset
df_lim <- df |> 
    rename(
        state = bene_state_desc,
        state_abbr = bene_state_abrvtn,
        county = bene_county_desc,
        county_fips = bene_fips_cd
        ) |> 
    filter(
        state == {focus_state},
        month == "Year",
        bene_geo_lvl == "County",
        year %in% c(2020, 2024)
        )


# #conver to date
# df_lim <- df_lim |> 
#     mutate(date = str_glue("{year} {month}") |> ym()) 
    
#limit to cols of interest
df_lim <- df_lim |> 
    select(year, state, state_abbr, county, county_fips, tot_benes)

```

## Access Spatial Data

We need to pull in the spatial data to create a map, leveraging the [`tigris` package](https://github.com/walkerke/tigris). 

```{r}
#| label: spatial
#| cache: true

# Download county boundaries for your state
state_counties <- counties(state = unique(df_lim$state_abbr), cb = TRUE, year = max(df_lim$year))

# Convert to sf object if needed
state_counties_sf <- st_as_sf(state_counties)

# Ensure FIPS codes match data format
state_counties_sf <- state_counties_sf %>%
  mutate(county_fips = GEOID)

```

# IMPORTANT ANALYSIS SECTION

Time to do some calculations!

## Calculate Growth Rate

Here we will create the growth rate.

```{r}
#reshape
df_gr <- df_lim |> 
    mutate(pd = ifelse(year == max(year), "end", "start")) |> 
    select(-year) |> 
    pivot_wider(
        names_from = pd,
        values_from = tot_benes)

df_gr <- df_gr |> 
    mutate(
        gr_pct = (end - start) / start,
        gr_abs = end - start)
```

## Join Data

Next up its time to join the data.
```{r}
#| label: merge

df_viz <- state_counties_sf %>%
  left_join(df_gr, by = "county_fips")

```

# VIZ

Okay, time for the fun stuff - data viz!

## Top Counties

Here are the top 5 counties and their growth rates

```{r}
#| label: county growth rate tbl
#| output: true

df_gr |> 
    slice_max(order_by = gr_pct, n = 5) |> 
    select(county, start, end, gr_pct) |> 
    gt() |>  
    fmt_number(
        columns = c(start, end),
        decimals = 0
    ) |> 
    fmt_percent(
        columns = gr_pct,
        decimals = 1 
            ) |> 
    cols_label(
        county = "County",
        start = 2020,
        end = 2024,
        gr_pct = "Growth Rate"
    ) 

```

## State Map

And here is a map of the state

```{r}
#| label: county growth rate
#| output: true

df_viz |> 
    ggplot() +
    geom_sf(aes(fill = gr_pct), color = "white", size = 0.2) +
    geom_sf_text(
        data = df_viz |> slice_max(order_by = gr_pct, n = 5),
        aes(label = county), na.rm = TRUE,
        ) +
    scale_fill_gradient2(
        low = "#af8dc3",
        mid = "#f7f7f7",
        high = "#7fbf7b",
        midpoint = 0,
        name = "Growth (%)",
        labels = percent_format(scale = 1)
    ) +
    labs(
        x = NULL, y = NULL,
        title = "Medicare Beneficiary Growth by County",
        subtitle = str_glue("{focus_state} | Percent change in total enrollment (2020-2024)"),
        caption = "Source: Medicare Monthly Enrollment Data, Data.CMS.gov"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(face = "bold", size = 16),
        legend.position = "top",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()
    )
```

